blueprint:
  name: Bedtime Routine
  description: >
    A manually triggered bedtime routine that turns off lights, music, and
    devices, then checks the security state of your home and runs tiered alert
    actions depending on what is found open.

    **Alert levels:**

    - Level 1 â€“ All Good (green): All windows, doors, and garage doors are
      closed. Run a "Good night, all secure âœ…" notification or scene.
    - Level 2 â€“ Windows Open (orange): One or more window sensors report open.
      Run an informational notification ðŸŸ .
    - Level 3 â€“ Door / Garage Open (red): A door or garage door is open.
      Run an urgent notification ðŸ”´ (e.g. Signal message or HA notification to
      the person who triggered the routine).

    Level 2 and Level 3 can both trigger in the same run when both windows and
    doors/garage are open. Level 1 only runs when neither Level 2 nor Level 3
    is triggered.

    Trigger this script from the Home Assistant Companion app, a dashboard
    button, or an iOS / Android shortcut.
  domain: script
  source_url: https://github.com/twentythree-ch/ha-blueprints/blob/main/bedtime-routine/bedtime_routine.yaml
  input:

    # â”€â”€ Devices to turn off â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    lights_to_turn_off:
      name: Lights to Turn Off
      description: >
        Lights or light groups to turn off as part of the bedtime routine.
        You can select individual entities, devices, or entire areas.
        Leave empty to skip this step.
      default: {}
      selector:
        target:
          entity:
            domain: light

    media_to_turn_off:
      name: Music / Media Players to Turn Off
      description: >
        Media players (speakers, TV, etc.) to turn off.
        You can select individual entities, devices, or entire areas.
        Leave empty to skip this step.
        Note: uses the media_player.turn_off service â€“ for streaming-only
        players that do not support turn_off, add a stop/pause call in
        Additional Actions instead.
      default: {}
      selector:
        target:
          entity:
            domain: media_player

    switches_to_turn_off:
      name: Devices / Switches to Turn Off
      description: >
        Switches or smart plugs to turn off.
        Leave empty to skip this step.
      default: []
      selector:
        entity:
          domain: switch
          multiple: true

    additional_actions:
      name: Additional Actions
      description: >
        Any extra actions to run unconditionally before the house-state check
        (e.g. set a night scene, lock a door, adjust a thermostat).
      default: []
      selector:
        action: {}

    # â”€â”€ House state sensors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window_sensors:
      name: Window Sensors
      description: >
        Binary sensors for windows (device class: window). If any sensor
        reports open (state = on), Level 2 actions are triggered.
        Leave empty to skip the window check.
      default: []
      selector:
        entity:
          domain: binary_sensor
          device_class: window
          multiple: true

    door_sensors:
      name: Door Sensors
      description: >
        Binary sensors for doors (device class: door). If any sensor reports
        open (state = on), Level 3 actions are triggered.
        Leave empty to skip the door check.
      default: []
      selector:
        entity:
          domain: binary_sensor
          device_class: door
          multiple: true

    garage_sensors:
      name: Garage Door Sensors
      description: >
        Binary sensors for garage doors (device class: garage_door). If any
        sensor reports open (state = on), Level 3 actions are triggered.
        Leave empty to skip the garage check.
      default: []
      selector:
        entity:
          domain: binary_sensor
          device_class: garage_door
          multiple: true

    # â”€â”€ Alert actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    level1_actions:
      name: "Level 1 â€“ All Good Actions (green)"
      description: >
        Actions to run when all windows, doors, and the garage are closed.
        Example: send a "Good night, all secure âœ…" notification.
      default: []
      selector:
        action: {}

    level1_alert_lights:
      name: "Level 1 â€“ Alert Lights"
      description: >
        Lights to turn on as a visual Level 1 alert (all good).
        They will be turned off automatically after the configured duration.
        Leave empty to skip the light alert.
      default: []
      selector:
        entity:
          domain: light
          multiple: true

    level1_alert_brightness_pct:
      name: "Level 1 â€“ Alert Light Brightness"
      description: Brightness of the alert lights (1â€“100 %).
      default: 100
      selector:
        number:
          min: 1
          max: 100
          unit_of_measurement: "%"

    level1_alert_color_enabled:
      name: "Level 1 â€“ Enable Alert Light Color"
      description: Turn on to apply a specific RGB color to the alert lights.
      default: false
      selector:
        boolean: {}

    level1_alert_color:
      name: "Level 1 â€“ Alert Light Color"
      description: RGB color applied when color is enabled (default green ðŸŸ¢).
      default: [0, 255, 0]
      selector:
        color_rgb: {}

    level1_alert_effect:
      name: "Level 1 â€“ Alert Light Effect"
      description: >
        Light effect name (e.g. "colorloop", "pulse"). Leave empty for none.
      default: ""
      selector:
        text: {}

    level1_alert_transition:
      name: "Level 1 â€“ Alert Light Transition"
      description: Transition time in seconds for turning the alert lights on and off.
      default: 1
      selector:
        number:
          min: 0
          max: 30
          unit_of_measurement: s

    level1_alert_duration:
      name: "Level 1 â€“ Alert Light Duration"
      description: >
        Fade-out duration in seconds. After the light turns on and reaches full
        brightness it immediately starts fading to off over this many seconds,
        entirely on the hardware side so the script does not block.
      default: 30
      selector:
        number:
          min: 1
          max: 3600
          mode: box
          unit_of_measurement: s

    level2_actions:
      name: "Level 2 â€“ Windows Open Actions (orange)"
      description: >
        Actions to run when one or more windows are open.
        Example: send a "Window still open ðŸŸ " notification.
      default: []
      selector:
        action: {}

    level2_alert_lights:
      name: "Level 2 â€“ Alert Lights"
      description: >
        Lights to turn on as a visual Level 2 alert (window open).
        They will be turned off automatically after the configured duration.
        Leave empty to skip the light alert.
      default: []
      selector:
        entity:
          domain: light
          multiple: true

    level2_alert_brightness_pct:
      name: "Level 2 â€“ Alert Light Brightness"
      description: Brightness of the alert lights (1â€“100 %).
      default: 100
      selector:
        number:
          min: 1
          max: 100
          unit_of_measurement: "%"

    level2_alert_color_enabled:
      name: "Level 2 â€“ Enable Alert Light Color"
      description: Turn on to apply a specific RGB color to the alert lights.
      default: false
      selector:
        boolean: {}

    level2_alert_color:
      name: "Level 2 â€“ Alert Light Color"
      description: RGB color applied when color is enabled (default orange ðŸŸ ).
      default: [255, 165, 0]
      selector:
        color_rgb: {}

    level2_alert_effect:
      name: "Level 2 â€“ Alert Light Effect"
      description: >
        Light effect name (e.g. "colorloop", "pulse"). Leave empty for none.
      default: ""
      selector:
        text: {}

    level2_alert_transition:
      name: "Level 2 â€“ Alert Light Transition"
      description: Transition time in seconds for turning the alert lights on and off.
      default: 1
      selector:
        number:
          min: 0
          max: 30
          unit_of_measurement: s

    level2_alert_duration:
      name: "Level 2 â€“ Alert Light Duration"
      description: >
        How long (seconds) the alert lights stay on before turning off
        automatically.
      default: 30
      selector:
        number:
          min: 1
          max: 3600
          mode: box
          unit_of_measurement: s

    level3_actions:
      name: "Level 3 â€“ Door / Garage Open Actions (red)"
      description: >
        Actions to run when a door or garage door is open.
        Example: send an urgent Signal message or HA notification ðŸ”´ to the
        person who triggered the routine.
      default: []
      selector:
        action: {}

    level3_alert_lights:
      name: "Level 3 â€“ Alert Lights"
      description: >
        Lights to turn on as a visual Level 3 alert (door/garage open).
        They will be turned off automatically after the configured duration.
        Leave empty to skip the light alert.
      default: []
      selector:
        entity:
          domain: light
          multiple: true

    level3_alert_brightness_pct:
      name: "Level 3 â€“ Alert Light Brightness"
      description: Brightness of the alert lights (1â€“100 %).
      default: 100
      selector:
        number:
          min: 1
          max: 100
          unit_of_measurement: "%"

    level3_alert_color_enabled:
      name: "Level 3 â€“ Enable Alert Light Color"
      description: Turn on to apply a specific RGB color to the alert lights.
      default: false
      selector:
        boolean: {}

    level3_alert_color:
      name: "Level 3 â€“ Alert Light Color"
      description: RGB color applied when color is enabled (default red ðŸ”´).
      default: [255, 0, 0]
      selector:
        color_rgb: {}

    level3_alert_effect:
      name: "Level 3 â€“ Alert Light Effect"
      description: >
        Light effect name (e.g. "colorloop", "strobe"). Leave empty for none.
      default: ""
      selector:
        text: {}

    level3_alert_transition:
      name: "Level 3 â€“ Alert Light Transition"
      description: Transition time in seconds for turning the alert lights on and off.
      default: 1
      selector:
        number:
          min: 0
          max: 30
          unit_of_measurement: s

    level3_alert_duration:
      name: "Level 3 â€“ Alert Light Duration"
      description: >
        How long (seconds) the alert lights stay on before turning off
        automatically.
      default: 30
      selector:
        number:
          min: 1
          max: 3600
          mode: box
          unit_of_measurement: s

# Make inputs available as variables for use in Jinja2 templates.
variables:
  lights_target: !input lights_to_turn_off
  media_target: !input media_to_turn_off
  switches_to_turn_off: !input switches_to_turn_off
  window_sensors: !input window_sensors
  door_sensors: !input door_sensors
  garage_sensors: !input garage_sensors
  level1_alert_lights: !input level1_alert_lights
  level1_alert_brightness_pct: !input level1_alert_brightness_pct
  level1_alert_color_enabled: !input level1_alert_color_enabled
  level1_alert_color: !input level1_alert_color
  level1_alert_effect: !input level1_alert_effect
  level1_alert_transition: !input level1_alert_transition
  level1_alert_duration: !input level1_alert_duration
  level2_alert_lights: !input level2_alert_lights
  level2_alert_brightness_pct: !input level2_alert_brightness_pct
  level2_alert_color_enabled: !input level2_alert_color_enabled
  level2_alert_color: !input level2_alert_color
  level2_alert_effect: !input level2_alert_effect
  level2_alert_transition: !input level2_alert_transition
  level2_alert_duration: !input level2_alert_duration
  level3_alert_lights: !input level3_alert_lights
  level3_alert_brightness_pct: !input level3_alert_brightness_pct
  level3_alert_color_enabled: !input level3_alert_color_enabled
  level3_alert_color: !input level3_alert_color
  level3_alert_effect: !input level3_alert_effect
  level3_alert_transition: !input level3_alert_transition
  level3_alert_duration: !input level3_alert_duration

sequence:
  # â”€â”€ Step 1: Turn off lights â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - continue_on_error: true
    choose:
      - conditions:
          - condition: template
            value_template: >-
              {% set t = lights_target | default({}) %}
              {{ (t.entity_id | default([]) | length > 0)
                 or (t.area_id | default([]) | length > 0)
                 or (t.device_id | default([]) | length > 0) }}
        sequence:
          - service: light.turn_off
            target: !input lights_to_turn_off

  # â”€â”€ Step 2: Turn off media players â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - continue_on_error: true
    choose:
      - conditions:
          - condition: template
            value_template: >-
              {% set t = media_target | default({}) %}
              {{ (t.entity_id | default([]) | length > 0)
                 or (t.area_id | default([]) | length > 0)
                 or (t.device_id | default([]) | length > 0) }}
        sequence:
          - service: media_player.turn_off
            target: !input media_to_turn_off

  # â”€â”€ Step 3: Turn off switches / devices â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - continue_on_error: true
    choose:
      - conditions:
          - condition: template
            value_template: "{{ switches_to_turn_off | length > 0 }}"
        sequence:
          - service: switch.turn_off
            target:
              entity_id: "{{ switches_to_turn_off | join(',') }}"

  # â”€â”€ Step 4: Run additional actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - continue_on_error: true
    choose:
      - conditions: []
        sequence: !input additional_actions

  # â”€â”€ Step 5: Evaluate house state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - continue_on_error: true
    variables:
      windows_open: >-
        {% set ns = namespace(open=false) %}
        {% for s in window_sensors %}
          {% if is_state(s, 'on') %}{% set ns.open = true %}{% endif %}
        {% endfor %}
        {{ ns.open }}
      doors_or_garage_open: >-
        {% set ns = namespace(open=false) %}
        {% for s in door_sensors + garage_sensors %}
          {% if is_state(s, 'on') %}{% set ns.open = true %}{% endif %}
        {% endfor %}
        {{ ns.open }}

  # â”€â”€ Level 3: door or garage open â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Notifications and alert lights run in parallel so neither blocks the other.
  - continue_on_error: true
    choose:
      - conditions:
          - condition: template
            value_template: "{{ doors_or_garage_open }}"
        sequence:
          - parallel:
              - sequence: !input level3_actions
              - sequence:
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ level3_alert_lights | length > 0 }}"
                        sequence:
                          - variables:
                              _l3_data: >-
                                {% set d = {'brightness_pct': level3_alert_brightness_pct | int(100),
                                            'transition': level3_alert_transition | int(1)} %}
                                {% if level3_alert_color_enabled %}
                                  {% set d = dict(d, rgb_color=level3_alert_color) %}
                                {% endif %}
                                {% if level3_alert_effect | length > 0 %}
                                  {% set d = dict(d, effect=level3_alert_effect) %}
                                {% endif %}
                                {{ d }}
                          - service: light.turn_on
                            target:
                              entity_id: "{{ level3_alert_lights }}"
                            data: "{{ _l3_data }}"
                          - delay:
                              seconds: "{{ level3_alert_duration | int(30) }}"
                          - service: light.turn_off
                            target:
                              entity_id: "{{ level3_alert_lights }}"
                            data:
                              transition: "{{ level3_alert_transition | int(1) }}"

  # â”€â”€ Level 2: windows open â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Notifications and alert lights run in parallel so neither blocks the other.
  - continue_on_error: true
    choose:
      - conditions:
          - condition: template
            value_template: "{{ windows_open }}"
        sequence:
          - parallel:
              - sequence: !input level2_actions
              - sequence:
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ level2_alert_lights | length > 0 }}"
                        sequence:
                          - variables:
                              _l2_data: >-
                                {% set d = {'brightness_pct': level2_alert_brightness_pct | int(100),
                                            'transition': level2_alert_transition | int(1)} %}
                                {% if level2_alert_color_enabled %}
                                  {% set d = dict(d, rgb_color=level2_alert_color) %}
                                {% endif %}
                                {% if level2_alert_effect | length > 0 %}
                                  {% set d = dict(d, effect=level2_alert_effect) %}
                                {% endif %}
                                {{ d }}
                          - service: light.turn_on
                            target:
                              entity_id: "{{ level2_alert_lights }}"
                            data: "{{ _l2_data }}"
                          - delay:
                              seconds: "{{ level2_alert_duration | int(30) }}"
                          - service: light.turn_off
                            target:
                              entity_id: "{{ level2_alert_lights }}"
                            data:
                              transition: "{{ level2_alert_transition | int(1) }}"

  # â”€â”€ Level 1: all good â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Notifications and alert lights run in parallel so neither blocks the other.
  - continue_on_error: true
    choose:
      - conditions:
          - condition: template
            value_template: "{{ not doors_or_garage_open and not windows_open }}"
        sequence:
          - parallel:
              - sequence: !input level1_actions
              - sequence:
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ level1_alert_lights | length > 0 }}"
                        sequence:
                          - variables:
                              _l1_data: >-
                                {% set d = {'brightness_pct': level1_alert_brightness_pct | int(100),
                                            'transition': level1_alert_transition | int(1)} %}
                                {% if level1_alert_color_enabled %}
                                  {% set d = dict(d, rgb_color=level1_alert_color) %}
                                {% endif %}
                                {% if level1_alert_effect | length > 0 %}
                                  {% set d = dict(d, effect=level1_alert_effect) %}
                                {% endif %}
                                {{ d }}
                          - service: light.turn_on
                            target:
                              entity_id: "{{ level1_alert_lights }}"
                            data: "{{ _l1_data }}"
                          - delay:
                              seconds: "{{ level1_alert_duration | int(30) }}"
                          - service: light.turn_off
                            target:
                              entity_id: "{{ level1_alert_lights }}"
                            data:
                              transition: "{{ level1_alert_transition | int(1) }}"

mode: single
max_exceeded: silent
